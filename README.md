# NicheRunner

NicheRunner is a spatial transcriptomics runner that turns presets + dataset registries into
reproducible SLURM-ready pipeline runs with structured preflight checks.
This project extends the paper `Engineering_Spatial_and_Molecular_Features_from_Cellular_Niches_to_Inform_Predictions_of_Inflammatory_Bowel_Disease.pdf`.

## Features

- Preset-driven configs with organ/platform compatibility filters.
- Dataset registry with cached schema manifests for fast preflight checks.
- Run orchestration (prepare, submit, queue) with artifact browsing and logs.
- Optional SLURM fallback for preflight join-key validation.

## Repository layout

- `apps/api` FastAPI backend (auth, preflight, runs, registry endpoints).
- `apps/web` Next.js UI (wizard for presets, datasets, runs).
- `presets/` analysis presets used by the API/UI.
- `registries/` dataset registry (e.g., `registries/datasets.json`).
- `pipeline_assets/` notebooks, scripts, and templates used by the pipeline.
- `scripts/` helper utilities (dataset manifest generation).
- `examples/` sanitized example configs and run inputs.
- `runs/` runtime output (ignored in git; do not commit).
- `deploy/` Docker and Nginx deployment notes.
- `docs/` additional documentation.

## Quickstart (local)

### API

```bash
cd apps/api
python -m venv .venv

# On Linux/Mac:
. .venv/bin/activate

# On Windows:
source .venv/Scripts/activate

pip install -r requirements.txt
pip install -r requirements-dev.txt
uvicorn app.main:app --reload
```

### Web UI

```bash
cd apps/web
npm install
export NEXT_PUBLIC_API_BASE=http://localhost:8000
npm run dev
```

PowerShell:

```powershell
cd apps/web
npm install
$env:NEXT_PUBLIC_API_BASE="http://localhost:8000"
npm run dev
```

Login uses a secure cookie. Set `BASIC_AUTH_USER`/`BASIC_AUTH_PASS` (or `AUTH_PASSWORD_HASH`)
and `SESSION_SECRET` before deployment.

## Running a pipeline

Runs can be created via the UI or the API. The pipeline script is generated by
`run_pipeline.py` based on a config and can emit SLURM scripts when requested.
For a CLI-style flow (including SSH submitter guidance), see `docs/SSH_SUBMITTER.md`.
For production HPG environment setup, see `docs/HPG_SETUP.md`.

The config typically includes:

- `run_name`, `mode`, `stages`
- `cosmx_h5ad_path`, `reference_h5ad_path`, `cell_metadata_path`
- optional `dataset_id` to resolve paths from the registry
- `slurm` settings for scheduling

## Dataset registry

The dataset registry lives in `registries/datasets.json`. Use
`scripts/generate_dataset_manifest.py` to compute cached schema manifests
(obs keys, metadata columns, raw counts flags) and store them in the registry.

See `apps/api/README.md` for full CLI usage and registry schema.

## Preflight validation

Preflight checks include:

- required config keys
- paths inside allowlisted roots
- path existence and readability
- join-key compatibility using cached manifests or live validation

If `anndata`/`pandas` are not available on the API host, enable
`PREFLIGHT_SLURM_FALLBACK=true` to run a short SLURM validation job.

## Deployment

Docker and Nginx notes live in `deploy/README.md`.

## Testing

```bash
pytest apps/api/tests
```

## Notes for publishing

- Keep runtime output in `runs/` (gitignored).
- Keep examples sanitized in `examples/`.
- Set strong secrets for `SESSION_SECRET` and auth credentials.

## Citation

If you use NicheRunner, please cite:

Engineering Spatial and Molecular Features from Cellular Niches to Inform Predictions of Inflammatory Bowel Disease.  
Myles Joshua Toledo Tan, Maria Kapetanaki, Panayiotis V. Benos.  
arXiv:2509.09923 (2025). https://doi.org/10.48550/arXiv.2509.09923

BibTeX:

```bibtex
@article{tan2025engineering,
  title = {Engineering Spatial and Molecular Features from Cellular Niches to Inform Predictions of Inflammatory Bowel Disease},
  author = {Tan, Myles Joshua Toledo and Kapetanaki, Maria and Benos, Panayiotis V.},
  year = {2025},
  eprint = {2509.09923},
  archivePrefix = {arXiv},
  primaryClass = {q-bio},
  doi = {10.48550/arXiv.2509.09923},
  url = {https://arxiv.org/abs/2509.09923}
}
```
