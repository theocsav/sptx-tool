# RunSpec and RunState (current contract)

This document reflects the **current** pipeline and API behavior in this repo.
It is based on `run_pipeline.py`, `apps/api/app/validation.py`, and the API schema.

## RunSpec (config)

RunSpec is the JSON config used by `run_pipeline.py` and the API. It is built from:

1) preset JSON
2) optional UI/API overrides
3) dataset registry resolution (when `dataset_id` is set)

### Core fields

Required for a pipeline run:

- `run_name` (string)
- `mode` (`fixed_k` or `elbow_k`)
- `stages` (list of stages)
- `cosmx_h5ad_path`
- `reference_h5ad_path`
- `cell_metadata_path`

### Stages

Allowed stages (order of execution is the list order):

- `cell2loc_nmf`
- `post_nmf`
- `rcausal_mgm`
- `mlp`
- `report`

### Data paths and outputs

- `cosmx_h5ad_path` (spatial h5ad)
- `reference_h5ad_path` (scRNA reference h5ad)
- `cell_metadata_path` (cell metadata CSV)
- `dataset_id` (optional; resolved via dataset registry)
- `run_dir` (optional; default `runs/<run_name>`)
- `output_dir` (optional; default `<run_dir>/outputs`)
- `ref_model_dir` (optional; default `<output_dir>/reference`)
- `ref_model_name` (optional)
- `inf_aver_name` (optional)

### NMF parameters

- `mode`: `fixed_k` or `elbow_k`
- `n_components` or `k` (fixed k)
- `k_min`, `k_max` (elbow k)

### Post-NMF

- `post_nmf_mode`: `papermill` or `python` (default `papermill`)
- `post_nmf_notebook_path` (papermill)
- `post_nmf_script_path` (python)
- `post_nmf_parameters` (dict)
- `post_nmf_args` (list)

### RCausalMGM

- `rcausal_mode`: `papermill` or `python` (default `papermill`)
- `rcausal_notebook_path` (papermill)
- `rcausal_script_path` (python)
- `rcausal_parameters` (dict)
- `rcausal_args` (list)
- `rcausal_output_dir` (optional)
- `rcausal_h5ad_path` (optional)
- `rcausal_niche_h5ad_path` / `rcausal_neighborhood_h5ad_path` (optional)

Default behavior when `rcausal_args` is not provided:

- `--output-dir <output_dir>/rcausal_mgm`
- `--niche-h5ad` and `--neighborhood-h5ad` resolve to:
  - `rcausal_*_h5ad_path` if provided, else
  - `rcausal_h5ad_path` if provided, else
  - `<output_dir>/cosmx_with_nmf.h5ad`

### MLP

- `mlp_script_path`
- `mlp_args` (list)

### Report

- `report_title`
- `report_notes`

### SLURM

`slurm` is a nested object used for sbatch generation:

- `enabled` (bool)
- `job_name`
- `time`
- `mem`
- `cpus_per_task`
- `account`
- `partition`
- `qos`
- `mail_user`
- `mail_type`
- `conda_env`
- `use_module_conda` (optional)

### Preflight validation (optional)

Used by `POST /runs/preflight`:

- `check_join_keys` (bool)
- `join_key_strategy` (`auto`, `unique_cell_id`, `fov_cell_id`)
- `join_key_delimiter`
- `max_missing_fraction`, `max_missing_count`
- `required_obs_keys`, `required_metadata_columns`
- `require_raw_counts`
- `preflight_slurm` (override slurm settings for SLURM preflight)

## Example RunSpec

```json
{
  "run_name": "ibd_cosmx_k4",
  "mode": "fixed_k",
  "stages": ["cell2loc_nmf", "post_nmf", "rcausal_mgm", "mlp", "report"],
  "cosmx_h5ad_path": "/blue/.../GSE234713_CosMx_combined.h5ad",
  "reference_h5ad_path": "/blue/.../combined_10x_reference_final.h5ad",
  "cell_metadata_path": "/blue/.../GSE234713_CosMx_cell_metadata.csv.gz",
  "n_components": 4,
  "post_nmf_mode": "papermill",
  "post_nmf_notebook_path": "pipeline_assets/IBD_Post_NMF_Analysis.ipynb",
  "rcausal_mode": "python",
  "rcausal_script_path": "pipeline_assets/IBD_RCausalMGM_Preparation.py",
  "mlp_script_path": "pipeline_assets/IBD_MLP_44Features.py",
  "report_title": "NicheRunner Paper Run",
  "slurm": {
    "enabled": true,
    "conda_env": "/blue/<group>/<user>/conda/envs/nicherunner",
    "time": "96h",
    "mem": "400gb",
    "cpus_per_task": 8
  }
}
```

## RunState (API + DB)

RunState is the persisted run metadata stored in `runs.db` and returned by the API.
It is defined in `apps/api/app/schemas.py` as `RunState` and used by `RunResponse`.

Fields in `RunResponse`:

- `id`
- `run_name`
- `status`
- `stage` (reserved; not actively used in pipeline yet)
- `run_dir`
- `output_dir`
- `config_path`
- `job_id`
- `slurm_state`
- `slurm_reason`
- `slurm_exit_code`
- `slurm_exit_signal`
- `slurm_elapsed`
- `submitted_at`
- `started_at`
- `finished_at`
- `message`
- `created_at`
- `updated_at`

Status values currently seen:

- `created`
- `queued`
- `prepared`
- `submitted`
- `running`
- `succeeded`
- `failed`
- `canceled`
- `error`
- `unknown`

Notes:

- The worker polls SLURM (`sacct` / `squeue`) and maps states to run `status`.
- Per-stage states are not tracked yet; only overall job status exists.

Artifacts:

- `artifacts/manifest.json` (generated by the report stage)
- `artifacts/run_summary.json` (generated by the report stage; summary metadata)

## Smoke test (no compute)

Use the dev config and stub metadata to verify the RunSpec contract and script generation
without executing the pipeline:

```bash
python run_pipeline.py --config examples/dev_smoke/config.json --emit-sbatch
```

This should generate:

- `runs/dev_smoke/run.sh`
- `runs/dev_smoke/submit.sh`
- `runs/dev_smoke/dev_smoke_pipeline.py`

If you use the API preflight with the stub metadata file, disable join-key checks:

```json
{
  "check_join_keys": false
}
```

## Dry run (API)

Use `POST /runs/dry-run` to validate config and generate scripts without creating a run record
or submitting a job. It returns stdout/stderr plus the resolved config:

```json
{
  "run_name": "dev_smoke",
  "preset_path": "ibd_cosmx_k4.json",
  "emit_sbatch": true,
  "check_paths": true
}
```

## Dry run (CLI)

Generate scripts without running them:

```bash
python run_pipeline.py --config examples/dev_smoke/config.json --dry-run --emit-sbatch
```

Validate a config without writing files (use `--skip-path-checks` if paths are not accessible):

```bash
python run_pipeline.py --config examples/dev_smoke/config.json --validate
```
